<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>éŠå…·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | éŠå…·ç•°å¸¸æ’®å½±ãƒšãƒ¼ã‚¸</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/destyle.css@1.0.15/destyle.css"/>
        <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
    </head>
    <body>
        <header class="header">
            <div class="flexbox">
                <h1><a href="{{ url_for('home') }}">éŠå…·ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </a></h1>
                <div class="account_toggle" id="mobile">
                    <img src="{{ url_for('static', filename='img/Icon.svg') }}" alt="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" id="accountIcon">
                </div>
                <button><img src="{{ url_for('static', filename='img/bell.png') }}"></button>
                <div class="nav_wrapper">
                    <input type="checkbox" id="nav_toggle" hidden>
                    <label class="nav_icon" for="nav_toggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </label>
                    <div class="overlay"></div>
                    <nav class="nav">
                        <ul>
                            <li><a href="{{ url_for('home') }}">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a></li>
                            <li><a href="{{ url_for('daily_report') }}">æ—¥å ±ä½œæˆ</a></li>
                            <li><a href="{{ url_for('results_report') }}">çµæœå ±å‘Šæ›¸ä½œæˆ</a></li>
                            <li><a href="{{ url_for('CheckSheet') }}">ç‚¹æ¤œãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ</a></li>
                            <li><a href="{{ url_for('Deterioration') }}">åŠ£åŒ–é€²è¡Œãƒ»åŠ£åŒ–äºˆæ¸¬</a></li>
                            <li><a href="{{ url_for('PhotoViewing') }}">å†™çœŸé–²è¦§</a></li>
                            <li><a href="{{ url_for('AllDocuments') }}">æ›¸é¡ä¸€è¦§</a></li>         
                        </ul>
                    </nav>
                </div>
            </div>
        </header>
        <div class="wrapper" id="TakePhoto">
            <p id="page_route"><a href="{{ url_for('home') }}">ãƒˆãƒƒãƒ—</a> > <a href="#">ãƒ–ãƒ©ãƒ³ã‚³</a> > <a href="{{ url_for('CheckSheet') }}">ç‚¹æ¤œãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ</a> > <a href="{{ url_for('TakePhoto') }}">éŠå…·ç•°å¸¸æ’®å½±</a></p><br>
            
            <!-- ä¿®æ­£: id="backButton" ã‚’è¿½åŠ  -->
            <button id="backButton"><img class="BackButton" src="{{ url_for('static', filename='img/back.png') }}"><p>æˆ»ã‚‹</p></button><br>

            <!-- ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="camera-container">
                <video id="cameraStream" autoplay playsinline></video>
                <canvas id="captureCanvas" style="display: none;"></canvas>
            </div>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="message" class="message"></div>

            <!-- AIåˆ¤å®šçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="aiResult" class="ai-result">
                <h3>ğŸ¤– AIåˆ¤å®šçµæœ</h3>
                <div id="aiResultContent"></div>
                <div class="confidence-bar">
                    <div id="confidenceFill" class="confidence-fill"></div>
                </div>
            </div>

            <div class="PhotoButton" id="photoButtonContainer">
                <button id="photoButton"><img src="{{ url_for('static', filename='img/PhotoButton.png') }}"></button>
            </div>
            <div class="NewButtons" id="newButtonsContainer" style="display: none;">
                <button id="retakeButton">å†æ’®å½± <img src="{{ url_for('static', filename='img/CameraIcon.png') }}" alt="å†æ’®å½±"></button>               
                <button id="saveButton">ä¿å­˜<img src="{{ url_for('static', filename='img/back.png') }}"></button>
            </div>
        </div>

        <script>
            // [æ—¢å­˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾ - å¤‰æ›´ãªã—]
            let capturedImage = null;
            let isLoading = false;
            let stream = null;
            let aiResultData = null;

            const urlParams = new URLSearchParams(window.location.search);
            const inspectionId = urlParams.get('inspection_id') || 1;
            const rowIndex = urlParams.get('row_index') || 1;

            console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            console.log('   - inspection_id:', inspectionId);
            console.log('   - row_index:', rowIndex);

            const videoElement = document.getElementById('cameraStream');
            const canvasElement = document.getElementById('captureCanvas');
            const photoButtonContainer = document.getElementById('photoButtonContainer');
            const newButtonsContainer = document.getElementById('newButtonsContainer');
            const retakeButton = document.getElementById('retakeButton');
            const saveButton = document.getElementById('saveButton');
            const backButton = document.getElementById('backButton');
            const messageElement = document.getElementById('message');
            const aiResultElement = document.getElementById('aiResult');
            const aiResultContent = document.getElementById('aiResultContent');
            const confidenceFill = document.getElementById('confidenceFill');

            function startCamera() {
                console.log('ğŸ“¹ ã‚«ãƒ¡ãƒ©èµ·å‹•é–‹å§‹...');
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(mediaStream) {
                        console.log('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
                        stream = mediaStream;
                        videoElement.srcObject = stream;
                        videoElement.play();
                    })
                    .catch(function(err) {
                        console.error('âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
                        showMessage('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    });
            }

            document.addEventListener('DOMContentLoaded', startCamera);

            photoButtonContainer.addEventListener('click', capturePhoto);

            function capturePhoto() {
                console.log('ğŸ“· æ’®å½±ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                try {
                    const ctx = canvasElement.getContext('2d');
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    ctx.drawImage(videoElement, 0, 0);
                    capturedImage = canvasElement.toDataURL('image/png');
                    console.log('âœ… å†™çœŸã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†');
                    photoButtonContainer.style.display = 'none';
                    newButtonsContainer.style.display = 'flex';
                    showMessage('å†™çœŸã‚’æ’®å½±ã—ã¾ã—ãŸã€‚é€ä¿¡ã—ã¦ãã ã•ã„ã€‚', 'info');
                } catch (error) {
                    console.error('âŒ æ’®å½±ã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                }
            }

            retakeButton.addEventListener('click', retakePhoto);

            function retakePhoto() {
                console.log('ğŸ”„ å†æ’®å½±');
                capturedImage = null;
                aiResultData = null;
                photoButtonContainer.style.display = 'block';
                newButtonsContainer.style.display = 'none';
                aiResultElement.classList.remove('show');
                hideMessage();
            }

            saveButton.addEventListener('click', submitPhoto);

            async function submitPhoto() {
                console.log('ğŸ’¾ é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                if (!capturedImage) {
                    showMessage('å†™çœŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
                if (isLoading) {
                    console.log('â³ æ—¢ã«é€ä¿¡ä¸­ã§ã™');
                    return;
                }

                saveButton.disabled = true;
                retakeButton.disabled = true;
                isLoading = true;
                showMessage('é€ä¿¡ä¸­... AIè§£æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™', 'info');

                try {
                    const apiUrl = `/api/inspection/${inspectionId}/upload_photo`;
                    console.log('ğŸ”— API URL:', apiUrl);

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            photo_data: capturedImage,
                            filename: `inspection_${inspectionId}_${new Date().toISOString().slice(0, 10)}.png`,
                            row_index: rowIndex
                        })
                    });

                    console.log('ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('âœ… é€ä¿¡æˆåŠŸï¼', result);

                    if (result.chain_condition && result.chain_confidence !== undefined) {
                        const chainResult = convertChainConditionToGrade(result.chain_condition);
                        
                        aiResultData = {
                            part: 'chain',
                            condition: result.chain_condition,
                            result: chainResult,
                            confidence: result.chain_confidence,
                            rowIndex: rowIndex,
                            timestamp: new Date().toISOString()
                        };

                        displayAIResult(aiResultData);
                        localStorage.setItem('latestAIResult', JSON.stringify(aiResultData));
                        console.log('ğŸ’¾ localStorage ã«ä¿å­˜:', aiResultData);

                        const resultLabel = aiResultData.result === 'A' ? 'ç•°å¸¸ãªã—' : 
                                          aiResultData.result === 'B' ? 'çµŒéè¦³å¯Ÿ' : 'è¦å¯¾å¿œ';
                        showMessage(`âœ“ AIåˆ¤å®šå®Œäº†ï¼åˆ¤å®š: ${aiResultData.result}ï¼ˆ${resultLabel}ï¼‰ ç¢ºä¿¡åº¦: ${(result.chain_confidence * 100).toFixed(1)}%`, 'success');
                    } else {
                        showMessage('âœ“ å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    }

                    setTimeout(function () {
                        console.log('â† CheckSheet ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™');
                        window.location.href = '/CheckSheet';
                    }, 3000);

                } catch (error) {
                    console.error('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    showMessage(`âœ— é€ä¿¡å¤±æ•—: ${error.message}`, 'error');
                    saveButton.disabled = false;
                    retakeButton.disabled = false;
                } finally {
                    isLoading = false;
                }
            }

            function convertChainConditionToGrade(condition) {
                if (condition === 'rust') {
                    return 'C';
                } else {
                    return 'A';
                }
            }

            function displayAIResult(data) {
                console.log('ğŸ¤– AIçµæœè¡¨ç¤º:', data);
                const resultLabels = { 'A': 'ç•°å¸¸ãªã—', 'B': 'çµŒéè¦³å¯Ÿ', 'C': 'è¦å¯¾å¿œ' };
                const conditionLabels = { 'nomal': 'ğŸŸ¢ éŒ†ãªã—', 'rust': 'ğŸ”´ éŒ†ã‚ã‚Š' };
                const label = resultLabels[data.result] || data.result;
                const conditionLabel = conditionLabels[data.condition] || data.condition;
                const confidencePercent = (data.confidence * 100).toFixed(1);

                aiResultContent.innerHTML = `
                    <p><strong>æ¤œæŸ»å¯¾è±¡:</strong> é–</p>
                    <p><strong>çŠ¶æ…‹:</strong> ${conditionLabel}</p>
                    <p><strong>åˆ¤å®š:</strong> ${data.result} - ${label}</p>
                    <p><strong>ç¢ºä¿¡åº¦:</strong> ${confidencePercent}%</p>
                `;
                confidenceFill.style.width = `${confidencePercent}%`;
                aiResultElement.classList.add('show');
            }

            function showMessage(msg, type) {
                messageElement.textContent = msg;
                messageElement.className = `message ${type}`;
            }

            function hideMessage() {
                messageElement.textContent = '';
                messageElement.className = 'message';
            }

            backButton.addEventListener('click', function () {
                console.log('â† æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                stopCamera();
                window.location.href = '/CheckSheet';
            });

            function stopCamera() {
                console.log('â¹ï¸ ã‚«ãƒ¡ãƒ©åœæ­¢');
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('   - ãƒˆãƒ©ãƒƒã‚¯åœæ­¢:', track.kind);
                    });
                    stream = null;
                    videoElement.srcObject = null;
                }
            }

            window.addEventListener('beforeunload', function() {
                stopCamera();
            });

            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('â¸ï¸ ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸ');
                    stopCamera();
                } else {
                    console.log('â–¶ï¸ ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                    if (!stream && videoElement) {
                        startCamera();
                    }
                }
            });

            window.addEventListener('error', function(event) {
                console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            });

            window.addEventListener('unhandledrejection', function(event) {
                console.error('âŒ Promise ã‚¨ãƒ©ãƒ¼:', event.reason);
            });
        </script>
        <script src="{{ url_for('static', filename='JS/JS.js')}}"></script>
    </body>
</html>