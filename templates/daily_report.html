<!DOCTYPE html>
<html lang="ja">
  <head>
      <meta charset="UTF-8">
      <title>遊具管理システム | 日報作成ページ</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/destyle.css@1.0.15/destyle.css"/>
      <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
  </head>
  <body>
        <header class="header">
            <div class="flexbox">
                <h1><a href="{{ url_for('home') }}">遊具管理システム</a></h1>
                <div class="account_toggle" id="mobile">
                    <img src="{{ url_for('static', filename='img/Icon.svg') }}" alt="アカウント" id="accountIcon">
                </div>
                <button><img src="{{ url_for('static', filename='img/bell.png') }}"></button>
                <div class="nav_wrapper">
                    <input type="checkbox" id="nav_toggle" hidden>
                    <label class="nav_icon" for="nav_toggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </label>
                    <div class="overlay"></div>
                    <nav class="nav">
                        <ul>
                            <li><a href="{{ url_for('home') }}">トップページ</a></li>
                            <li><a href="{{ url_for('daily_report') }}">日報作成</a></li>
                            <li><a href="{{ url_for('results_report') }}">結果報告書作成</a></li>
                            <li><a href="{{ url_for('CheckSheet') }}">点検チェックシート</a></li>
                            <li><a href="{{ url_for('Deterioration') }}">劣化進行・劣化予測</a></li>
                            <li><a href="{{ url_for('PhotoViewing') }}">写真閲覧</a></li>
                            <li><a href="{{ url_for('AllDocuments') }}">書類一覧</a></li>         
                        </ul>
                    </nav>
                </div>
            </div>
        </header>
    <div class="wrapper">
      <div id="daily_report_container">
        <p id="page_route"><a href="{{ url_for('home') }}">トップ</a> > <a href="{{ url_for('daily_report') }}">日報作成</a></p>
        <div id="flex_container">
          <div id="left_container">
            <p class="daily_report_heading">公園名</p>
            <input class="text_box wide_box" type="text" name="park">
            <p class="daily_report_heading">報告者名</p>
            <input class="text_box wide_box" type="text" name="reporter">
            <p class="daily_report_heading">点検・報告日</p>
            <div id="date_column_container">
              <select class="text_box" name="era_name">
                <option value="令和">令和</option>
                <option value="平成">平成</option>
                <option value="昭和">昭和</option>
              </select>
              <select class="text_box" name="year">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
              </select>
              <p class="date_text">年度</p>
              <select class="text_box" name="month">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
              <p class="date_text">月</p>
              <select class="text_box" name="date">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>   
              </select>
              <p>日</p>
            </div>
            <div  class="daily_report_heading" id="daily_inspection_results_container">
              <p>点検結果</p>
              <div>
                <input type="checkbox" name="result" value="全て問題なし">全て問題なし              
              </div>
            </div>
             <table>
  <tr>
    <th>遊具名</th>
    <th>異常の種類</th>
    <th>写真アップロード</th>
    <th>劣化度</th>
    
  </tr>
  <tr>
  <td contenteditable="true"></td>
  <td contenteditable="true"></td>
  <td>
    <input type="file" accept="image/*" name="photo1" class="photo-input" data-index="1">
    <button type="button"
        class="remove-photo"
        data-index="1"
        style="
            padding:4px 8px;
            border:1px solid #aaa;
            border-radius:3px;
            background:#ebebeb;
            font-size:14px;
            line-height:1.2;
            margin:2px 0;
        ">削除
    </button>
  </td>
  <td>
    <p class="degradation-score" id="deg-score-1"></p>
  </td>
</tr>
  <tr>
    
    <td contenteditable="true"></td>
    <td contenteditable="true"></td>
    <td>
    <input type="file" accept="image/*" name="photo1" class="photo-input" data-index="2">
    <button type="button" class="remove-photo" data-index="2"style="
            padding:4px 8px;
            border:1px solid #aaa;
            border-radius:3px;
            background:#ebebeb;
            font-size:14px;
            line-height:1.2;
            margin:2px 0;
        ">削除</button>
  </td>
    <td>
    <p class="degradation-score" id="deg-score-2"></p>
  </td>
  </tr>
  <tr>
    
    <td contenteditable="true"></td>
    <td contenteditable="true"></td>
    <td>
    <input type="file" accept="image/*" name="photo1" class="photo-input" data-index="3">
    <button type="button" class="remove-photo" data-index="3"style="
            padding:4px 8px;
            border:1px solid #aaa;
            border-radius:3px;
            background:#ebebeb;
            font-size:14px;
            line-height:1.2;
            margin:2px 0;
        ">削除</button>
  </td>
    <td>
    <p class="degradation-score" id="deg-score-3"></p>
  </td>
  </tr>
</table>
            <p class="daily_report_heading">備考</p>
            <textarea class="text_box" name="remarks" rows="7" cols="50"></textarea>
          </div>
          <div id="right_container">
            <div id="image_heading">
              <p>写真</p>
              <button id="add_photo" type="button">＋</button>
            </div>
            <div id="image_container">
              <img src="{{ url_for('static', filename='img/photo_image.png') }}">
              <img src="{{ url_for('static', filename='img/photo_image.png') }}">
              <img src="{{ url_for('static', filename='img/photo_image.png') }}">
              <img src="{{ url_for('static', filename='img/photo_image.png') }}">                
            </div>
          </div>
        </div>
        <div id="daily_completed_container_bottom">
            <button id="daily_completed" type="button">保存</button>
        </div>
      </div>
    </div>
    <footer>
       
    </footer>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // 写真アップロード時（劣化度取得）
    document.querySelectorAll(".photo-input").forEach(input => {
        input.addEventListener("change", async (event) => {
            const index = event.target.dataset.index;
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("photo", file);

            try {
                const response = await fetch("/api/degradation", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();

                document.getElementById(`deg-score-${index}`).textContent =
                    result.degradation_ratio !== undefined ? `${result.degradation_ratio}%` : "解析エラー";

            } catch (err) {
                console.error(err);
                document.getElementById(`deg-score-${index}`).textContent = "解析失敗";
            }
        });
    });

    // 削除ボタン処理
    document.querySelectorAll(".remove-photo").forEach(btn => {
        btn.addEventListener("click", (event) => {
            const index = event.target.dataset.index;

            // input の値をクリア
            const input = document.querySelector(`input[data-index="${index}"]`);
            input.value = "";

            // 劣化度もクリア
            document.getElementById(`deg-score-${index}`).textContent = "";
        });
    });
});

</script>

</body>
</html>
