# 公園遊具安全点検システム

## 📋 概要

公園遊具安全点検システムは、公園の遊具の安全点検業務をデジタル化し、効率化するためのWebアプリケーションです。日常点検から定期点検、報告書作成まで、遊具の安全管理に必要な機能を包括的に提供します。

AI（機械学習）による画像認識機能を搭載し、ブランコなどの遊具の劣化状態（錆、ひび割れ等）を自動判定することで、点検業務の精度向上と効率化を実現します。

## ✨ 主な機能

### 🔍 点検管理
- **日報作成**: 日常の巡回点検結果を記録
- **定期点検チェックシート**: 詳細な定期点検の実施と記録
- **点検履歴管理**: 過去の点検結果の閲覧・検索

### 🤖 AI自動判定
- **画像認識による劣化判定**: 
  - ブランコの鎖（chain）の錆検出
  - 継ぎ手（joint）の錆検出
  - ポール（pole）の錆検出
  - 座面（seat）の錆・ひび割れ検出
- **信頼度スコア表示**: AI判定の確信度を表示
- **判定結果の可視化**: 劣化箇所を視覚的に確認

### 📊 報告書作成
- **結果報告書自動生成**: Excelフォーマットでの報告書作成
- **写真添付機能**: 点検時の写真を報告書に自動挿入
- **判定等級の自動計算**: A（健全）～D（使用禁止）の4段階評価

### 📈 劣化予測・分析
- **劣化進行状況の可視化**: 時系列での劣化推移グラフ
- **劣化予測機能**: 過去データから将来の劣化を予測
- **設備ごとの状態管理**: 遊具ごとのステータス追跡

### 📸 写真管理
- **写真閲覧機能**: 撮影した点検写真の一覧表示
- **写真と点検記録の紐付け**: 点検データと写真の関連管理
- **画像データベース**: 効率的な画像保存・取得

### 👥 ユーザー管理
- **役割ベースのアクセス制御**:
  - 事務職員: 日報・報告書作成
  - 点検者: 点検実施・写真撮影
  - 管理者: システム全体の管理
- **公園別の担当者割当**: 点検者を公園に割り当て

## 🛠️ 技術スタック

### バックエンド
- **Flask**: Pythonウェブフレームワーク (v3.1.2)
- **Flask-SQLAlchemy**: ORM (v3.1.1)
- **Flask-Migrate**: データベースマイグレーション (v4.1.0)
- **PyMySQL**: MySQLドライバー (v1.1.2)

### データベース
- **MySQL**: リレーショナルデータベース

### AI/機械学習
- **TensorFlow**: 深層学習フレームワーク (v2.20.0)
- **Keras**: 高レベルニューラルネットワークAPI (v3.10.0)
- **PyTorch**: 深層学習フレームワーク (v2.9.1)
- **MobileNetV2**: 画像分類モデル（転移学習）

### 画像処理
- **Pillow**: 画像処理ライブラリ (v11.3.0)
- **OpenCV**: コンピュータービジョンライブラリ

### フロントエンド
- **HTML/CSS/JavaScript**: 標準的なWeb技術
- **Jinja2**: テンプレートエンジン

### その他
- **openpyxl**: Excelファイル操作
- **python-dotenv**: 環境変数管理

## 📁 プロジェクト構造

```
## 📁 プロジェクト構造


park-equipment-safety-vision/
├── app.py                    # メインアプリケーション
├── run.py                    # アプリケーション起動スクリプト
├── config.py                 # 設定ファイル
├── models.py                 # データベースモデル定義
├── requirements.txt          # Pythonパッケージ依存関係
├── .env                      # 環境変数設定ファイル
├── .gitignore                # Git除外設定
├── ER_DIAGRAM.md             # データベース設計図
├── template.xlsx             # Excel報告書テンプレート
│
├── train_models.py           # AIモデル訓練スクリプト
├── chain_generate_data.py    # 鎖データ生成
├── seat_generate_data.py     # 座面データ生成
├── upload_photo.py           # 写真アップロード機能
├── check_data.py             # データチェックユーティリティ
├── test.py                   # テストスクリプト
│
├── old_app.py                # 旧アプリケーション（参考用）
├── models_old.py             # 旧モデル定義（参考用）
│
├── backend/                  # バックエンド関連
│   └── app.py               # バックエンドロジック
│
├── templates/                # HTMLテンプレート
├── static/                   # 静的ファイル（CSS、JS、画像）
├── icons/                    # アイコン画像
├── docs/                     # ドキュメント・デモページ
│
├── migrations/               # データベースマイグレーションファイル
└── data/
    └── raw/                  # 学習用生データ

```

## 🚀 セットアップ手順

### 1. 必要要件

- Python 3.8以上
- MySQL 5.7以上
- pip（Pythonパッケージマネージャー）

### 2. リポジトリのクローン

```bash
git clone https://github.com/wmCmo/park-equipment-safety-vision.git
cd park-equipment-safety-vision
```

### 3. 仮想環境の作成と有効化

```bash
# 仮想環境の作成
python -m venv venv

# 仮想環境の有効化（Windows）
venv\Scripts\activate

# 仮想環境の有効化（Mac/Linux）
source venv/bin/activate
```

### 4. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```



### 5. データベースのセットアップ

```bash
# データベースの作成（MySQLクライアントで実行）
mysql -u root -p
CREATE DATABASE park_equipment_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# マイグレーションの初期化
flask db init

# マイグレーションの作成
flask db migrate -m "Initial migration"

# データベースの更新
flask db upgrade
```

### 7. SSL証明書の生成（HTTPSアクセス用）

```bash
# 自己署名証明書の生成
openssl req -x509 -newkey rsa:4096 -nodes -out cert.pem -keyout key.pem -days 365
```

### 8. アプリケーションの起動

```bash
python run.py
```

アプリケーションは `https://localhost:5000` でアクセスできます。

## 💻 使用方法

### 初回ログイン

1. ブラウザで `https://localhost:5000` にアクセス
2. 管理者アカウントでログイン（初期データをインポートしている場合）
3. ユーザー管理画面から新規ユーザーを追加

### 日報作成

1. トップページから「日報作成」を選択
2. 対象の公園を選択
3. 異常を発見した遊具を記録
4. 写真を撮影・アップロード
5. 保存して完了

### 定期点検の実施

1. 「点検チェックシート」を選択
2. 対象の公園と遊具を選択
3. 各部位（鎖、継ぎ手、ポール、座面）の写真を撮影
4. AIが自動で劣化状態を判定
5. 必要に応じて手動で判定を修正
6. 総合評価を確認して保存

### 報告書の作成

1. 「結果報告書作成」を選択
2. 対象期間と公園を選択
3. 含める点検データを選択
4. 「報告書生成」をクリック
5. Excelファイルがダウンロードされます

### 劣化予測の確認

1. 「劣化進行・劣化予測」を選択
2. 対象の遊具を選択
3. 劣化進行グラフと予測結果を確認
4. 必要に応じて対策を計画

## 🗄️ データベース構成

システムは以下の主要テーブルで構成されています：

### 主要テーブル

- **users**: 従業員情報（事務職員、点検者、管理者）
- **parks**: 公園情報（公園名、住所、担当者）
- **equipments**: 遊具情報（遊具名、ステータス）
- **inspection**: 通常点検セッション（点検日時、総合評価）
- **inspection_detail**: 点検パーツ詳細（部位、状態、AI判定結果）
- **daily_reports**: 日報（報告日、公園、作成者）
- **daily_report_detail**: 日報の異常記録（異常内容、劣化度）
- **photo**: 写真データ（画像、メタデータ）
- **reports**: 報告書（作成日時、ステータス）
- **inspection_reports**: 点検と報告書の中間テーブル

詳細なER図は [ER_DIAGRAM.md](ER_DIAGRAM.md) を参照してください。

## 🤖 AI機能について

### 訓練済みモデル

本システムは以下の4つの部位について、個別の画像分類モデルを使用しています：

1. **鎖（chain）**: 正常 / 錆B / 錆C
2. **継ぎ手（joint）**: 正常 / 錆B / 錆C
3. **ポール（pole）**: 正常 / 錆B / 錆C
4. **座面（seat）**: 正常 / 錆B / 錆C / ひび割れB / ひび割れC

※ B: 経過観察レベル、C: 要修繕レベル

### モデルの訓練

新しいデータでモデルを再訓練する場合：

```bash
# データの準備（data/フォルダに画像を配置）
python chain_generate_data.py  # 鎖データの生成
python seat_generate_data.py   # 座面データの生成

# モデルの訓練
python train_models.py
```

### 判定の流れ

1. ユーザーが遊具部位の写真をアップロード
2. 画像が前処理（リサイズ、正規化）される
3. 該当する訓練済みモデルで推論を実行
4. 最も確率の高いクラスと信頼度スコアを返す
5. 結果をデータベースに保存（AI判定フラグ付き）

### 判定精度

- MobileNetV2ベースの転移学習を使用
- 目標精度: 90%以上
- データ拡張技術により汎化性能を向上

## 📝 開発情報

### データベースマイグレーション

モデルを変更した場合：

```bash
# マイグレーションファイルの生成
flask db migrate -m "変更内容の説明"

# データベースに反映
flask db upgrade

# 必要に応じてロールバック
flask db downgrade
```

### テストデータの投入

```bash
# サンプルデータの生成スクリプトを実行
python check_data.py
```

## 🔒 セキュリティ

- パスワードはハッシュ化して保存（Werkzeug Security）
- HTTPS通信の使用（SSL/TLS）
- セッション管理によるログイン状態の保持
- 役割ベースのアクセス制御（RBAC）

## 📄 ライセンス

このプロジェクトは個別のライセンス条項に従います。詳細は権利者にお問い合わせください。

## 🤝 貢献

このプロジェクトへの貢献を歓迎します。プルリクエストを送信する前に、以下の点を確認してください：

1. コードスタイルが既存のコードと一致していること
2. 適切なテストが含まれていること
3. ドキュメントが更新されていること

## 📧 お問い合わせ

質問や問題がある場合は、GitHubのIssuesページで報告してください。

---

**開発者向け注意事項**

- `.env`ファイルは機密情報を含むため、バージョン管理に含めないでください
- `data/`フォルダ内の学習データは容量が大きいため、Git LFSの使用を推奨します
- 本番環境では適切なデータベース設定とセキュリティ対策を実施してください
- SSL証明書は本番環境用の正式な証明書を使用してください
